---
title: "fars"
author: "Trevor"
date: "4/8/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```


```{r message=FALSE, warning=FALSE}
library(tidyverse)
crss <- read_csv("/Users/cpf/OneDrive - bjtu.edu.cn/Data/Modified/NHTSAdata/data/output_crss/dftwo0408.csv")

crss1 <- crss %>% 
  group_split(LGT, WEATHER2)
```


```{r warning=FALSE}
library(mvord)
results = vector("list", length(crss1))
names(results) = names(crss1)

for (i in seq_along(crss1)){
  results[i] = mvord(formula = MMO2(REST_USE.1, REST_USE.2, INJ_SEV.1,INJ_SEV.2) ~ 0 + AGE1.1+ DRINKING.1 + DRUGS.1 +AIR_BAG.1 + EJECTION.1 + ROLLOVER.1 + AGE1.2 + DRINKING.2+  DRUGS.2  + AIR_BAG.2+ EJECTION.2 + ROLLOVER.2 + MANCOLL,
                 threshold.constraints = c(1,2,3,4),
                 link = mvprobit(),data = crss1[i][[1]])
}
results

```

```{r}
head(crss1)
crss_l= crss %>%
  pivot_longer(-c(CASENUM, LGT, MANCOLL, WEATHHER, HOUR.1, WEATHER2, TYP_INT.1),
               names_to = c(".value", "VENO"),
               names_sep = "\\.",
               values_drop_na = TRUE)
head(crss_l)

group1 = crss_l %>% 
  filter(DRUGS < 7) %>% 
  select(-c(CASENUM,VEH_NO)) %>% 
  group_by(LGT,WEATHER2,VENO) %>% 
  summarise(across(everything(), list(mean=mean,sd=sd), na.rm=TRUE)) %>% 
  

t(as.matrix(group1))

crss_l %>% 
  count(LGT, WEATHER2, VENO, sort=TRUE)


group2= crss_l %>% 
  mutate(LGTW = case_when(LGT == 0 & WEATHER2 == 0 & VENO ==1 ~ "白天好天1",
                          LGT == 0 & WEATHER2 == 0 & VENO ==2 ~ "白天好天2",
                          LGT == 0 & WEATHER2 == 1 & VENO ==1 ~ "白天坏天1",
                          LGT == 0 & WEATHER2 == 1 & VENO ==2 ~ "白天坏天2",
                          LGT == 1 & WEATHER2 == 0 & VENO ==1 ~ "夜有灯好天1",
                          LGT == 1 & WEATHER2 == 0 & VENO ==2 ~ "夜有灯好天2",
                          LGT == 1 & WEATHER2 == 1 & VENO ==1 ~ "夜有灯坏天1",
                          LGT == 1 & WEATHER2 == 1 & VENO ==2 ~ "夜有灯坏天2",
                          LGT == 2 & WEATHER2 == 0 & VENO ==1 ~ "夜无灯好天1",
                          LGT == 2 & WEATHER2 == 0 & VENO ==2 ~ "夜无灯好天2",
                          LGT == 2 & WEATHER2 == 1 & VENO ==1 ~ "夜无灯坏天1",
                          LGT == 2 & WEATHER2 == 1 & VENO ==2 ~ "夜无灯坏天2")) %>% 
  count(LGTW,INJ_SEV)
## 添加字体
library(showtext)
font_add("kt", "/Users/cpf/Library/Fonts/楷体_GB2312.ttf")
showtext_auto()
# stacked + percent
group2 %>% 
  drop_na() %>% 
  ggplot(aes(fill=INJ_SEV, y= n, x = LGTW)) + 
  geom_bar(position="fill", stat = "identity") +
  scale_y_continuous(labels = scales::percent) + #纵坐标变为百分比
  labs(y = "受伤严重程度个数") +
  theme_gray()


```







